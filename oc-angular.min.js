/**
* oc-angular Angular utility module v1.0*
* @author Özgür Çimen 2015
*
*/

/*
FILTERS 
	-estimateTime 				
		using :
			{{timeStamp |estimateTime:{short:True}}}
DIRECTIVES
	-tableSort it's used for boostrap table shorting
	
	<oc-multi-select-box ng-model="selects" source-data="dataSource"></oc-multi-select-box>
		usage attributes
	 	 data-source =  [
	  		{id:"101", title:"Kategory",type:"divider",css:"item-red-box"}, //divider Item 
	     	{id:"1",title: "osman",css:"item-red-box"} //select item
	 	 ng-model = [] 
*/
window.oc=window.oc||{};var ocanMod=angular.module("oc-angular",[]);oc.controller=function(target,controller){target.controller(controller.name,controller)};oc.append=function(source,target){for(var i=0;i<source.length;i++){target.push(source[i])}};ocanMod.directive("ocDragDrop",function(){return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"A",scope:{onDropOver:"&",ocDragDrop:"=",transferData:"=",onDragEnd:"&"},link:function(scope,element,attrs,ctrl){element.attr("draggable","true");element.attr("id",new Date().getTime());scope.$watch("ocDragDrop",function(value){element.attr("draggable",value)});dragel=element[0];var opa=element.css("opacity");dragel.addEventListener("dragstart",function(e){e.dataTransfer.setData("sourceId",element.attr("id"));e.dataTransfer.setData("transfer_data",JSON.stringify(scope.transferData));element.css("opacity",".3")},false);dragel.addEventListener("dragend",function(e){element.css("opacity",opa);if(scope.onDragEnd){scope.onDragEnd({event:e})}},false);dragel.addEventListener("dragover",function(e){if(e.preventDefault){e.preventDefault()}},false);if(scope.onDropOver){dragel.addEventListener("drop",function(e){var sourceId=e.dataTransfer.getData("sourceId")||"";var transferedData=e.dataTransfer.getData("transfer_data");transferedData=(transferedData!="undefined")?JSON.parse(transferedData):"";var sourceElement=$("#"+sourceId)[0];var target;if(typeof $(e.target).attr("on-drop-over")=="undefined"){target=e.target.parentElement}else{target=e.target}scope.onDropOver({event:{data:transferedData,sourceElement:sourceElement,target:target}})},false)}}}});ocanMod.directive("ocMultiSelectBox",function(){var tpl='<div><div class="receiver-holder {{formControlCSS}} "><div ng-click="onclickItem({item:item});console.log(\'hoop\')" ng-repeat="item in model" class="oc-none-select receiver-item btn-sm {{(item.css) ? item.css :\'\'}} btn-addon"><i ng-click="onClickRemove($index)" class="fa fa-times pull-right"></i>{{item.title}}</div><input style=" outline: none;" type="text" ng-model="searchText"></div><ul class="oc-auto-list"><li ng-click="selectStaticItem($index)" ng-repeat="item in staticList" class="select-item static-item" data-index="{{$index}}"><i ng-if="item.icon" class="fa {{item.icon}} fa-fw text-muted"></i>&nbsp;{{item.title}}</li><li ng-click="selectItem(item)" ng-repeat="item in sourceData |filter:searchText | exclude:model" class="{{(item.type==\'divider\') ? \'divider\' : \'select-item\'}}" data-item="{{item}}">{{item.title}}</li></ul></div>';return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"E",link:function(scope,element,attrs,ctrl){if(typeof scope.border=="undefined"){scope.formControlCSS="form-control"}else{scope.formControlCSS=""}if(typeof scope.model=="undefined"){scope.model=[]}if(scope.model==null){scope.model=[]}var input=$(element).find("input").first();var list=$(".oc-auto-list");scope.searchText="";list.hide();scope.listElement=list;scope.input=input;scope.selectItem=function(item){if(item.type=="divider"){return}scope.model[scope.model.length]=item;scope.searchText="";scope.listElement.hide();scope.input.focus()};scope.onClickRemove=function(index){scope.model.splice(index,1);scope.listElement.hide()};scope.selectStaticItem=function(index){scope.searchText="";scope.listElement.hide();scope.input.focus();if(scope.onSelectStaticItem){scope.onSelectStaticItem({index:index})}};input[0].onkeydown=function(event){scope.showList();var key=event.keyCode||event.charCode;if(key==40){if(list.is(":visible")){var items=list.find(".select-item");var found=false;items.each(function(index){if($(this).hasClass("selected")){found=true;if(index<items.length-1){$(this).removeClass("selected");$(items[index+1]).addClass("selected");var offsettop=(list[0].scrollHeight/(items.length*40))*(index*40);console.log(offsettop);list[0].scrollTop=offsettop}return false}});if(!found){$(items[0]).addClass("selected");list[0].scrollTop=0}}event.preventDefault();return false}if(key==38){if(list.is(":visible")){var items=list.find(".select-item");var found=false;items.each(function(index){if($(this).hasClass("selected")){found=true;if(0<index){$(this).removeClass("selected");$(items[index+-1]).addClass("selected");var offsettop=(list[0].scrollHeight/(items.length*40))*((index-1)*40);list[0].scrollTop=offsettop}return !found}})}event.preventDefault();return false}if(key==8||key==46){scope.$apply(function(){if(scope.model.length>0){if(scope.searchText.length==0){list.hide();scope.model.splice(scope.model.length-1,1)}}else{scope.model=[]}})}if(key==13){if(list.is(":visible")){var items=list.find(".select-item.selected").first();if($(items[0]).hasClass("divider")){return}if(items.length>0){if($(items[0]).hasClass("static-item")){var indeX=$(items[0]).data("index");scope.selectStaticItem(indeX)}else{scope.$apply(function(){var itemData=$(items[0]).data("item");if(itemData.type=="divider"){return}var ix=scope.sourceData.map(function(x){return x.id}).indexOf(itemData.id);if(ix<0){return}scope.model[scope.model.length]=scope.sourceData[ix];scope.searchText="";scope.listElement.hide();scope.input.focus()})}}}event.preventDefault();return false}};input[0].onclick=function(){scope.showList()};function onInputBlur(){list.hide();input[0].onblur=null}input[0].onblur=onInputBlur;input[0].onmouseover=function(){input[0].onblur=onInputBlur};list[0].onmouseover=function(event){input[0].onblur=null;if(event.target){if(event.target.nodeName=="LI"||event.target.nodeName=="li"){if(!$(event.target).hasClass("selected")){list.find(".select-item").each(function(index){$(this).removeClass("selected")});$(event.target).addClass("selected")}}}};list[0].onmouseout=function(){input[0].onblur=onInputBlur};scope.showList=function(){list.show();input[0].onblur=onInputBlur}},scope:{model:"=ngModel",sourceData:"=",staticList:"=",onclickItem:"&",onSelectStaticItem:"&onselectStaticitem",border:"="},template:tpl}});ocanMod.directive("ocBoostrapDatetimepicker",function(){return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"A",link:function(scope,element,attrs,ctrl){element.datetimepicker()}}});ocanMod.directive("ocBoostrapDaterangePicker",function(){return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"A",scope:{target:"@",onApply:"&",options:"&"},link:function(scope,element,attrs,ctrl){var dateRange=$(element);if(typeof scope.options=="object"){dateRange.daterangepicker(options)}else{dateRange.daterangepicker({timePicker:true,timePickerIncrement:30,locale:{format:"MM/DD/YYYY h:mm A"},ranges:{"Bugün":[moment(),moment()],"Yarın":[moment(),moment().add(1,"days")],"7 gün sonra":[moment(),moment().add(6,"days")],"30 gün sonra":[moment(),moment().add(29,"days")]}})}dateRange.on("apply.daterangepicker",function(ev,picker){if(scope.onApply){scope.onApply({dateRange:{start:picker.startDate._d,end:picker.endDate._d}})}})}}});ocanMod.directive("ocInfiniteScroll",function($ocScrollDelegate){return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"A",scope:{ocInfiniteScroll:"&"},link:function(scope,element,attrs,ctrl){$(element).css("overflow","auto");$(element).css("overflow-x","hidden");$ocScrollDelegate.setAvailable(true);var target=element[0];target.addEventListener("scroll",function(event){if($ocScrollDelegate.getAvailable()){var h=$(target).height();var sh=target.scrollHeight;var st=target.scrollTop;if(sh-h<=st+5){$ocScrollDelegate.setAvailable(false);if(scope.ocInfiniteScroll){scope.ocInfiniteScroll()}}}})}}});ocanMod.directive("ocTableSortable",function(){return{restrict:"A",scope:{ocTableSortable:"&"},link:function(scope,element,attrs,ctrl){var target=angular.element(element);target.click(function(){if(target.hasClass("footable-sorted")){resetHeaders();target.addClass("footable-sorted-desc");target.removeClass("footable-sorted");scope.ocTableSortable({asc:true})}else{resetHeaders();target.removeClass("footable-sorted-desc");target.addClass("footable-sorted");scope.ocTableSortable({asc:false})}});function resetHeaders(){target.parent().find(".footable-sortable").removeClass("footable-sorted-desc footable-sorted")}}}});ocanMod.filter("estimateTime",function(){return function(value,params){if(typeof value!="number"||typeof value=="undefined"){return value}var ds="gün";var hs="saat";var ms="dakika";var ss="saniye";if(params){if(params.shorted){ms="dak";ss="san"}}var result="";var x=value/1000;var s=Math.floor(x%60);x/=60;var m=Math.floor(x%60);x/=60;var h=Math.floor(x%24);x/=24;var d=Math.floor(x);if(d>0){result=d+" "+ds+" "}if(h>0){result+=h+" "+hs+" "}if(m>0){result+=m+" "+ms+" "}if(s>0){result+=s+" "+ss+" "}return result}});ocanMod.filter("exclude",function(){return function(items,excludes){if(typeof items=="undefined"){return}if(typeof excludes=="undefined"){return items}var result=[];for(var i=0;i<items.length;i++){var item=items[i];if(excludes.indexOf(item)<0){result.push(item)}else{for(var k=0;k<excludes.length;k++){var exclude=excludes[k]}}}return result}});ocanMod.service("$ocScrollDelegate",function(){var scrollAvailable=false;this.infiniteScrollComplate=function(){scrollAvailable=true};this.setAvailable=function(value){scrollAvailable=value};this.getAvailable=function(){return scrollAvailable}});