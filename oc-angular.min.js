/**
* oc-angular Angular utility module v1.0*
* @author Özgür Çimen 2015
*
*/

/*
FILTERS 
	-estimateTime 				
		using :
			{{timeStamp |estimateTime:{short:True}}}
DIRECTIVES
	-tableSort it's used for boostrap table shorting

	<oc-multi-select-box ng-model="selects" source-data="dataSource"></oc-multi-select-box>
		usage attributes
	 	 data-source =  [
	  		{id:"101", title:"Kategory",type:"divider",css:"item-red-box"}, //divider Item 
	     	{id:"1",title: "osman",css:"item-red-box"} //select item
	 	 ng-model = [] 

	#DateRange 
		@oc-boostrap-daterange-picker 
		@on-apply on change date-range value 
		<button type="button" class="btn send-box-toolbutton" oc-boostrap-daterange-picker on-apply="onChangeDateRange(dateRange);" >
	        <span class="fa fa-calendar"></span><!--&nbsp;Tarih Ekle-->
	    </button>
*/
window.oc=window.oc||{};var ocanMod=angular.module("oc-angular",[]);oc.controller=function(target,controller){target.controller(controller.name,controller)};oc.append=function(source,target){for(var i=0;i<source.length;i++){target.push(source[i])}};oc.emptyArray=function(array){var k=array.length;while(k--){array.pop()}};oc.randomRange=function(min,max){return Math.floor(Math.random()*(max-min+1))+min};oc.trimArray=function(array,indexs){var shl=0;for(var i=0;i<indexs.length;i++){array.splice(parseInt(indexs[i])-i,1)}};ocanMod.directive("ocDragDrop",function(){return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"A",scope:{onDropOver:"&",ocDragDrop:"=",transferData:"=",onDragEnd:"&",deactiveDrag:"="},link:function(scope,element,attrs,ctrl){if(!scope.deactiveDrag){element.attr("draggable","true")}element.attr("id",new Date().getTime());scope.$watch("ocDragDrop",function(value){element.attr("draggable",value)});dragel=element[0];var opa=element.css("opacity");dragel.addEventListener("dragstart",function(e){e.dataTransfer.setData("sourceId",element.attr("id"));e.dataTransfer.setData("transfer_data",JSON.stringify(scope.transferData));element.css("opacity",".3")},false);dragel.addEventListener("dragend",function(e){element.css("opacity",opa);if(scope.onDragEnd){scope.onDragEnd({event:e})}},false);dragel.addEventListener("dragover",function(e){if(e.preventDefault){e.preventDefault()}},false);if(scope.onDropOver){dragel.addEventListener("drop",function(e){var sourceId=e.dataTransfer.getData("sourceId")||"";var transferedData=e.dataTransfer.getData("transfer_data");transferedData=(transferedData!="undefined")?JSON.parse(transferedData):"";var sourceElement=$("#"+sourceId)[0];var target;if(typeof $(e.target).attr("oc-drag-drop")=="undefined"){target=e.target.parentElement}else{target=e.target}scope.onDropOver({event:{data:transferedData,sourceElement:sourceElement,target:target}})},false)}}}});ocanMod.directive("ocMultiSelectBox",function(){var tpl='<div style="position:relative"><div class="receiver-holder {{formControlCSS}}" ><div ng-click="onclickItem({item:item});console.log(\'hoop\')" ng-repeat="item in model" class="oc-none-select receiver-item btn-sm {{(item.css) ? item.css :\'\'}} btn-addon"><i ng-click="onClickRemove($index)" class="fa fa-times pull-right"></i>{{item.title}}</div><input style=" outline: none;" type="text" ng-model="searchText" placeholder="{{(model.length > 0 ) ? \'\' : ph}}"></div><ul class="oc-auto-list"><li ng-click="selectStaticItem($index)" ng-repeat="item in staticList" class="select-item static-item" data-index="{{$index}}"><i ng-if="item.icon" class="fa {{item.icon}} fa-fw text-muted"></i>&nbsp;{{item.title}}</li><li ng-click="selectItem(item)" ng-repeat="item in sourceData |filter:searchText | exclude:model" class="{{(item.type==\'divider\') ? \'divider\' : \'select-item\'}}" data-item="{{item}}">{{item.title}}</li></ul></div>';return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"E",link:function(scope,element,attrs,ctrl){if(typeof scope.border=="undefined"){scope.formControlCSS="form-control"}else{scope.formControlCSS=""}if(typeof scope.model=="undefined"){scope.model=[]}if(scope.model==null){scope.model=[]}var input=$(element).find("input").first();var list=$(element).find(".oc-auto-list");scope.searchText="";list.hide();scope.listElement=list;scope.input=input;scope.selectItem=function(item){if(item.type=="divider"){return}scope.model[scope.model.length]=item;scope.searchText="";scope.listElement.hide();scope.input.focus()};scope.onClickRemove=function(index){scope.model.splice(index,1);scope.listElement.hide()};scope.selectStaticItem=function(index){scope.searchText="";scope.listElement.hide();scope.input.focus();if(scope.onSelectStaticItem){scope.onSelectStaticItem({index:index})}};input[0].onkeydown=function(event){scope.showList();var key=event.keyCode||event.charCode;if(key==40){if(list.is(":visible")){var items=list.find(".select-item");var found=false;items.each(function(index){if($(this).hasClass("selected")){found=true;if(index<items.length-1){$(this).removeClass("selected");$(items[index+1]).addClass("selected");var offsettop=(list[0].scrollHeight/(items.length*40))*(index*40);console.log(offsettop);list[0].scrollTop=offsettop}return false}});if(!found){$(items[0]).addClass("selected");list[0].scrollTop=0}}event.preventDefault();return false}if(key==38){if(list.is(":visible")){var items=list.find(".select-item");var found=false;items.each(function(index){if($(this).hasClass("selected")){found=true;if(0<index){$(this).removeClass("selected");$(items[index+-1]).addClass("selected");var offsettop=(list[0].scrollHeight/(items.length*40))*((index-1)*40);list[0].scrollTop=offsettop}return !found}})}event.preventDefault();return false}if(key==8||key==46){scope.$apply(function(){if(scope.model.length>0){if(scope.searchText.length==0){list.hide();scope.model.splice(scope.model.length-1,1)}}else{scope.model=[]}})}if(key==13){if(list.is(":visible")){var items=list.find(".select-item.selected").first();if($(items[0]).hasClass("divider")){return}if(items.length>0){if($(items[0]).hasClass("static-item")){var indeX=$(items[0]).data("index");scope.selectStaticItem(indeX)}else{scope.$apply(function(){var itemData=$(items[0]).data("item");if(itemData.type=="divider"){return}var ix=scope.sourceData.map(function(x){return x.id}).indexOf(itemData.id);if(ix<0){return}scope.model[scope.model.length]=scope.sourceData[ix];scope.searchText="";scope.listElement.hide();scope.input.focus()})}}}event.preventDefault();return false}};input[0].onclick=function(){scope.showList()};function onInputBlur(){list.hide();input[0].onblur=null}input[0].onblur=onInputBlur;input[0].onmouseover=function(){input[0].onblur=onInputBlur};list[0].onmouseover=function(event){input[0].onblur=null;if(event.target){if(event.target.nodeName=="LI"||event.target.nodeName=="li"){if(!$(event.target).hasClass("selected")){list.find(".select-item").each(function(index){$(this).removeClass("selected")});$(event.target).addClass("selected")}}}};list[0].onmouseout=function(){input[0].onblur=onInputBlur};scope.showList=function(){list.show();input[0].onblur=onInputBlur}},scope:{ph:"@placeholder",model:"=ngModel",sourceData:"=",staticList:"=",onclickItem:"&",onSelectStaticItem:"&onselectStaticitem",border:"="},template:tpl}});ocanMod.directive("ocBoostrapDatetimepicker",function(){return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"A",link:function(scope,element,attrs,ctrl){element.datetimepicker()}}});ocanMod.directive("ocBoostrapDaterangePicker",function($ocDateRangeDelegate){return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"A",scope:{onApply:"&",options:"=",onClear:"&",id:"@ocBoostrapDaterangePicker"},link:function(scope,element,attrs,ctrl){var dateRange=$(element);if(typeof scope.options=="object"){dateRange.daterangepicker(scope.options)}else{dateRange.daterangepicker()}dateRange.on("apply.daterangepicker",function(ev,picker){if(!scope.options.singleDatePicker){scope.model={start:picker.startDate._d,end:picker.endDate._d};if(scope.onApply){scope.onApply({dateRange:{start:picker.startDate._d,end:picker.endDate._d}})}}else{scope.model=picker.startDate._d;if(scope.onApply){scope.onApply({date:picker.startDate._d})}}scope.$apply()});dateRange.on("cancel.daterangepicker",function(ev,picker){if(scope.onClear){scope.onClear()}});if(scope.id){$ocDateRangeDelegate.set(scope.id,dateRange)}scope.$on("$destroy",function(){if(scope.id){$ocDateRangeDelegate.remove(scope.id)}})}}});ocanMod.directive("ocFullcalendar",function($timeout,$ocFullCalendarDelegate){return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"A",scope:{calendarId:"@ocFullcalendar",calenderOptions:"="},link:function(scope,element,attrs,ctrl){$(document).ready(function(){var calendar=$(element).fullCalendar(scope.calenderOptions);if(scope.calendarId){$ocFullCalendarDelegate._push(scope.calendarId,calendar)}})}}});ocanMod.directive("ocGmapPositionSelector",function($timeout,$ocMapDelegate){return{restrict:"A",scope:{mapId:"@ocGmapPositionSelector",centerPos:"=",options:"=",model:"=ngModel",addMode:"=",onclickMarker:"&"},link:function(scope,element,attrs,ctrl){var options=scope.options||{};var map=null;$timeout(function(){if(scope.centerPos){var center=new google.maps.LatLng(scope.centerPos.lat,scope.centerPos.lng);var zoom=14}else{var center={lat:39.2601934,lng:35.431615};var zoom=10}map=new google.maps.Map(element.context,{center:center,zoom:zoom});if(navigator.geolocation&&scope.centerPos==null){navigator.geolocation.getCurrentPosition(function(position){initialLocation=new google.maps.LatLng(position.coords.latitude,position.coords.longitude);map.setCenter(initialLocation)})}map.addListener("click",function(e){if(scope.addMode){if(map._proData.markers){for(var i=0;i<map._proData.markers.length;i++){map._proData.markers[i].setMap(null)}placeMarkerAndPanTo(e.latLng,map)}}});google.maps.event.trigger(map,"resize");map._proData={};if(scope.mapId){if(scope.onclickMarker){map._proData.onclickMarker=scope.onclickMarker}$ocMapDelegate.pushMap(scope.mapId,map)}if(scope.options.searchDisable!=true){initAutocomplete()}},300);function placeMarkerAndPanTo(latLng,map){if(scope.options.singlePointMode){if(map._proData.singleMarker){map._proData.singleMarker.setMap(null)}map._proData.singleMarker=new google.maps.Marker({position:latLng,map:map});scope.model.position={lat:latLng.lat(),lng:latLng.lng()},scope.$apply()}}scope.$on("$destroy",function(){$(element).remove();map=null;if(scope.mapId){$ocMapDelegate.removeMap(scope.mapId)}});function initAutocomplete(){var ainput=angular.element('<input id="pac-input" class="controls" type="text" placeholder="Ara">');$(element).parent().append(ainput);var input=ainput[0];var searchBox=new google.maps.places.SearchBox(input);map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);map.addListener("bounds_changed",function(){searchBox.setBounds(map.getBounds())});searchBox.addListener("places_changed",function(){var places=searchBox.getPlaces();if(places.length==0){return}var bounds=new google.maps.LatLngBounds();places.forEach(function(place){var icon={url:place.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};if(place.geometry.viewport){bounds.union(place.geometry.viewport)}else{bounds.extend(place.geometry.location)}});map.fitBounds(bounds)})}}}});ocanMod.directive("ocInfiniteScroll",function($ocScrollDelegate){return{author:{name:"Özgür Çimen 2014",mail:"derozgur@gmail.com",web:"cimenozgur.com",},restrict:"A",scope:{ocInfiniteScroll:"&"},link:function(scope,element,attrs,ctrl){function isScrolledIntoView(elem){var $elem=$(elem);var $window=$(window);var docViewTop=$window.scrollTop();var docViewBottom=docViewTop+$window.height();var elemTop=$elem.offset().top;var elemBottom=elemTop+$elem.height();return((elemBottom<=docViewBottom)&&(elemTop>=docViewTop))}$(element).css("overflow","auto");$(element).css("overflow-x","hidden");$ocScrollDelegate.setAvailable(true);var target=element[0];window.onscroll=function(event){if($ocScrollDelegate.getAvailable()){if(isScrolledIntoView(target)){$ocScrollDelegate.setAvailable(false);if(scope.ocInfiniteScroll){scope.ocInfiniteScroll()}}}};scope.$on("$destroy",function(){window.onscroll=null})}}});ocanMod.directive("ocSelect2",function($timeout){return{restrict:"A",scope:{ocSelect2:"&",model:"=ngModel"},link:function(scope,element,attrs,ctrl){$(element).select2();$timeout(function(){$(element).select2().val(scope.model)},200)}}});ocanMod.directive("ocTableSortable",function(){return{restrict:"A",scope:{ocTableSortable:"=",sortField:"@"},link:function(scope,element,attrs,ctrl){var target=angular.element(element);target.addClass("oc-sortable");$(element).find(".footable-sort-indicator").addClass("fa");resetHeaders();target.click(function(){if(target.hasClass("footable-sorted")){resetHeaders();target.addClass("footable-sorted-desc");target.removeClass("footable-sorted");var indacator=$(element).find(".footable-sort-indicator").first();if(indacator){indacator.removeClass("fa-sort");indacator.addClass("fa-caret-down")}scope.ocTableSortable=scope.sortField;scope.$apply()}else{resetHeaders();target.removeClass("footable-sorted-desc");target.addClass("footable-sorted");var indacator=$(element).find(".footable-sort-indicator").first();if(indacator){indacator.removeClass("fa-sort");indacator.addClass("fa-caret-up")}scope.ocTableSortable="-"+scope.sortField;scope.$apply()}});function resetHeaders(){target.parent().find(".oc-sortable").removeClass("footable-sorted-desc footable-sorted");var indacator=target.parent().find(".oc-sortable").find(".footable-sort-indicator");if(indacator){indacator.removeClass("fa-caret-up");indacator.removeClass("fa-caret-down");indacator.addClass("fa-sort")}}}}});ocanMod.filter("estimateTime",function(){return function(value,params){if(typeof value!="number"||typeof value=="undefined"){return value}var ds="gün";var hs="saat";var ms="dakika";var ss="saniye";if(params){if(params.shorted){ms="dak";ss="san"}}var result="";var x=value/1000;var s=Math.floor(x%60);x/=60;var m=Math.floor(x%60);x/=60;var h=Math.floor(x%24);x/=24;var d=Math.floor(x);if(d>0){result=d+" "+ds+" "}if(h>0){result+=h+" "+hs+" "}if(m>0){result+=m+" "+ms+" "}if(s>0){result+=s+" "+ss+" "}return result}});ocanMod.filter("exclude",function(){return function(items,excludes){if(typeof items=="undefined"){return}if(typeof excludes=="undefined"){return items}var result=[];for(var i=0;i<items.length;i++){var item=items[i];if(excludes.indexOf(item)<0){result.push(item)}else{for(var k=0;k<excludes.length;k++){var exclude=excludes[k]}}}return result}});ocanMod.service("$ocDateRangeDelegate",function($timeout){var delegates=[];this.set=function(id,range){delegates[id]=range};this.getDatePicker=function(id){console.log(delegates[id]);if(delegates[id]==null){$timeout(function(){return delegates[id]},200)}else{return delegates[id]}};this.remove=function(id){if(delegates[id]){delegates[id]=null}delete delegates[id]}});ocanMod.service("$ocFullCalendarDelegate",function($q,$timeout){var delegates=[];function CalendarDelagete(id){var calendar=delegates[id];var _p=this;_p.addEvents=function(events){if(!events||events.length<=0){return}calendar.fullCalendar("addEventSource",{events:events});calendar.fullCalendar("rerenderEvents")};_p.removeEvents=function(events){calendar.fullCalendar("removeEventSource",events)};_p.changeView=function(viewName){calendar.fullCalendar("changeView",viewName)};_p.getView=function(){return calendar.fullCalendar("getView")};_p.gotoDate=function(date){calendar.fullCalendar("gotoDate",date)};_p.getEvents=function(){return calendar.fullCalendar("clientEvents")}}this._push=function(id,com){delegates[id]=com};this._remove=function(id){if(delegates[id]){delegates[id]=null}delete delegates[id]};this.getDelegate=function(id){var deffered=$q.defer();$(document).ready(function(){$timeout(function(){if(delegates[id]!=null){deffered.resolve(new CalendarDelagete(id))}else{deffered.reject("calendar could not be found "+id)}},200)});return deffered.promise}});ocanMod.service("$ocMapDelegate",function($timeout){var maps=[];function MapDelagete(id){var _p=this;var infowindow=new google.maps.InfoWindow();_p.setCenter=function(pos){if(maps[id]!=null){maps[id].setCenter(new google.maps.LatLng(pos.lat,pos.lng))}};_p.setZoom=function(value){if(maps[id]!=null){maps[id].setZoom(value)}};_p.setMarkers=function(markers){if(maps[id]==null){$timeout(_apply,500)}else{_apply()}function _apply(){if(maps[id]!=null&&markers!=null){var map=maps[id];_p.clearMarkers();map._proData.markers=[];for(var i=0;i<markers.length;i++){var mark=markers[i];if(mark.position){var marker=new google.maps.Marker({position:new google.maps.LatLng(mark.position.lat,mark.position.lng),map:map,title:mark.title,data:mark});map._proData.markers.push(marker);google.maps.event.addListener(marker,"click",function(event){if(map._proData.onclickMarker){map._proData.onclickMarker({marker:this.data})}if(infowindow){infowindow.close()}if(this.data.title){infowindow.setContent("<div><strong>"+this.data.title+"</strong><br>");infowindow.open(map,this)}})}}}else{console.warn("map not found",id)}}};_p.getMarkers=function(){if(maps[id]==null){return console.warn("map not found",id)}var _map=maps[id];if(_map._proData.markers){return _map._proData.markers}return null};_p.openInfoWindow=function(marker,title){if(maps[id]==null){return console.warn("map not found",id)}var _map=maps[id];if(infowindow){infowindow.close()}infowindow.setContent("<div><strong>"+title+"</strong><br>");infowindow.open(_map,marker)};_p.clearMarkers=function(){if(maps[id]==null){return console.warn("map not found",id)}var _map=maps[id];if(_map._proData.markers){for(var i=0;i<_map._proData.markers.length;i++){_map._proData.markers[i].setMap(null)}_map._proData.markers=null;_map._proData.markers=[]}if(_map._proData.singleMarker){_map._proData.singleMarker.setMap(null)}_map._proData.singleMarker=null}}this.pushMap=function(id,map){maps[id]=map};this.removeMap=function(id){if(maps[id]){maps[id]=null}delete maps[id]};this.getMapDelegate=function(id){return new MapDelagete(id)}});ocanMod.factory("$ocPopup",function($rootScope,$timeout,$q,$compile,$templateRequest,$controller,$window){var OcPopup=function(options){var deffered=$q.defer();var _p=this;var posx=0;var posy=0;_p.close=function(val){$("body").removeClass("modal-open");$(document).off("mousedown",onmouseActive);$(backDrop).remove();deffered.resolve(val)};if(options.event){var $event=options.event;posx=$event.pageX;posy=$event.pageY}var _st1,_st2,popup;var modalScope=null;var ctrlLocals={};if(options.resolve){for(fn in options.resolve){ctrlLocals[fn]=options.resolve[fn].apply()}}ctrlLocals["$ocPopupInstance"]={close:_p.close};if(options.controller){modalScope=$rootScope.$new();ctrlLocals.$scope=modalScope;var ctrlInstance=$controller(options.controller,ctrlLocals)}var windowClass=options.windowClass||"";if(options.minWidth&&!options.minHeight){_st1="style='min-width:"+options.minWidth+"px;'"}if(!options.minWidth&&options.minHeight){_st1="style='min-height:"+options.minHeight+"px;'"}if(options.minWidth&&options.minHeight){_st1="style='min-width:"+options.minWidth+"px; min-height:"+options.minHeight+"px'"}if(_st1){popup=angular.element("<div "+_st1+" class='"+windowClass+" oc-free-com oc-popup-content'></div>")}else{popup=angular.element("<div class='"+windowClass+" oc-free-com oc-popup-content'></div>")}var backDrop=angular.element("<div class='oc-full-component black-shadow'></div>");backDrop.append(popup);$("body").addClass("modal-open");$("body").append(backDrop);if(options.templateUrl&&options.templateUrl.length>0){$templateRequest(options.templateUrl).then(function(resp){popup.html(resp);if(modalScope){$compile(popup)(modalScope)}else{if(options.scope){$compile(popup)(options.scope)}}$timeout(function(){$(popup).ready(function(){console.log("popupwith",popup.width());if(posx+popup.width()+50>$window.innerWidth){posx=posx-popup.width()}if(posy+popup.height()+50>$window.innerHeight){posy=posy-popup.height()}posy=(posy<0)?0:posy;$(popup).css("top",posy+"px");$(popup).css("left",posx+"px");$(popup).addClass("oc-fade-in");$(document).on("mousedown",onmouseActive)})},100)},function(err){console.error("Template cannot load",err)})}function onmouseActive(event){if($(backDrop).find(event.target).length==0){_p.close()}}return deffered.promise};return{show:function(options){return new OcPopup(options)}}});ocanMod.service("$ocScrollDelegate",function(){var scrollAvailable=false;this.infiniteScrollComplete=function(){scrollAvailable=true};this.setAvailable=function(value){scrollAvailable=value};this.getAvailable=function(){return scrollAvailable}});